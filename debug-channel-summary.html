<!DOCTYPE html>
<html>
<head>
    <title>SlackPolish Channel Summary Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .warning { background: #fff3cd; color: #856404; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; font-size: 12px; }
        .message-item { background: #f8f9fa; margin: 5px 0; padding: 8px; border-radius: 3px; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç SlackPolish Channel Summary Debug</h1>
        
        <div class="debug-section info">
            <h3>Instructions:</h3>
            <ol>
                <li>Open this page while Slack is running</li>
                <li>Navigate to a Slack channel with some messages</li>
                <li>Click the debug buttons below to see what's happening</li>
            </ol>
        </div>

        <div class="debug-section">
            <h3>üîß Debug Tests</h3>
            <button onclick="testChannelDetection()">Test Channel Detection</button>
            <button onclick="testMessageExtraction()">Test Message Extraction</button>
            <button onclick="testAPIConnection()">Test API Connection</button>
            <button onclick="runFullDebug()">Run Full Debug</button>
        </div>

        <div id="results"></div>
    </div>

    <script>
        function addResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const section = document.createElement('div');
            section.className = `debug-section ${type}`;
            section.innerHTML = `<h3>${title}</h3>${content}`;
            resultsDiv.appendChild(section);
        }

        function testChannelDetection() {
            addResult('üîç Channel Detection Test', 'Testing if we can detect the current Slack channel...');
            
            try {
                // Try to access Slack window (this will fail if not in Slack context)
                if (window.location.hostname !== 'app.slack.com') {
                    addResult('‚ùå Channel Detection Failed', 
                        'This debug tool needs to be run from within Slack context. ' +
                        'Copy this HTML file content and run it in Slack\'s developer console instead.', 'error');
                    return;
                }
                
                // Test channel header detection
                const channelHeader = document.querySelector('[data-qa="channel_header"]') || 
                                    document.querySelector('[data-qa="dm_header"]') ||
                                    document.querySelector('.p-view_header__channel_title');
                
                if (channelHeader) {
                    const channelName = channelHeader.textContent?.trim();
                    addResult('‚úÖ Channel Detection Success', 
                        `Found channel: <strong>${channelName}</strong>`, 'success');
                } else {
                    addResult('‚ùå Channel Detection Failed', 
                        'Could not find channel header. Available selectors: ' +
                        '<pre>' + Array.from(document.querySelectorAll('[data-qa*="header"]')).map(el => el.getAttribute('data-qa')).join('\n') + '</pre>', 'error');
                }
                
            } catch (error) {
                addResult('‚ùå Channel Detection Error', `Error: ${error.message}`, 'error');
            }
        }

        function testMessageExtraction() {
            addResult('üìù Message Extraction Test', 'Testing if we can extract messages from the current view...');
            
            try {
                // Test different message selectors
                const selectors = [
                    '[data-qa="message"]',
                    '.c-message',
                    '[data-qa="virtual-list-item"]',
                    '.p-rich_text_section'
                ];
                
                let foundMessages = 0;
                let bestSelector = null;
                
                selectors.forEach(selector => {
                    const elements = document.querySelectorAll(selector);
                    if (elements.length > foundMessages) {
                        foundMessages = elements.length;
                        bestSelector = selector;
                    }
                });
                
                if (foundMessages > 0) {
                    addResult('‚úÖ Message Extraction Success', 
                        `Found ${foundMessages} message elements using selector: <code>${bestSelector}</code>`, 'success');
                    
                    // Try to extract sample messages
                    const messageElements = document.querySelectorAll(bestSelector);
                    let sampleMessages = '';
                    
                    for (let i = 0; i < Math.min(3, messageElements.length); i++) {
                        const element = messageElements[i];
                        const text = element.textContent?.trim().substring(0, 100) + '...';
                        sampleMessages += `<div class="message-item">Sample ${i+1}: ${text}</div>`;
                    }
                    
                    addResult('üìã Sample Messages', sampleMessages, 'info');
                } else {
                    addResult('‚ùå Message Extraction Failed', 
                        'Could not find any message elements. Available elements: ' +
                        '<pre>' + Array.from(document.querySelectorAll('[data-qa]')).slice(0, 10).map(el => el.getAttribute('data-qa')).join('\n') + '</pre>', 'error');
                }
                
            } catch (error) {
                addResult('‚ùå Message Extraction Error', `Error: ${error.message}`, 'error');
            }
        }

        function testAPIConnection() {
            addResult('üîë API Connection Test', 'Testing OpenAI API connection...');
            
            // This would need to access the SlackPolish config
            try {
                if (typeof window.SLACKPOLISH_CONFIG !== 'undefined' && window.SLACKPOLISH_CONFIG.OPENAI_API_KEY) {
                    addResult('‚úÖ API Key Found', 'OpenAI API key is configured in SlackPolish', 'success');
                } else {
                    addResult('‚ùå API Key Missing', 'OpenAI API key not found in SlackPolish config', 'error');
                }
            } catch (error) {
                addResult('‚ùå API Connection Error', `Error: ${error.message}`, 'error');
            }
        }

        function runFullDebug() {
            document.getElementById('results').innerHTML = '';
            addResult('üöÄ Full Debug Started', 'Running comprehensive debug tests...');
            
            setTimeout(() => testChannelDetection(), 100);
            setTimeout(() => testMessageExtraction(), 200);
            setTimeout(() => testAPIConnection(), 300);
            
            setTimeout(() => {
                addResult('üéØ Debug Summary', 
                    'Debug complete. Check the results above to identify the issue. ' +
                    'Most likely causes:<ul>' +
                    '<li>Message extraction selectors need updating for current Slack version</li>' +
                    '<li>Channel detection logic needs adjustment</li>' +
                    '<li>JavaScript errors preventing execution</li>' +
                    '</ul>', 'warning');
            }, 500);
        }

        // Auto-run basic test on load
        setTimeout(() => {
            addResult('üîÑ Auto-Debug', 'Running automatic debug check...');
            if (window.location.hostname === 'app.slack.com') {
                testChannelDetection();
            } else {
                addResult('‚ÑπÔ∏è Usage Note', 
                    'To debug the channel summary feature:<ol>' +
                    '<li>Open Slack in your browser</li>' +
                    '<li>Press F12 to open Developer Tools</li>' +
                    '<li>Go to Console tab</li>' +
                    '<li>Copy and paste the JavaScript from this page</li>' +
                    '<li>Run the debug functions</li>' +
                    '</ol>', 'info');
            }
        }, 1000);
    </script>
</body>
</html>
